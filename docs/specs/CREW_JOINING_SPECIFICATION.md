# Crew Joining Feature - Technical Specification (MVP)

**Version:** 1.0
**Date:** 2025-10-25
**Status:** In Development
**Priority:** High

---

## üìã Executive Summary

This specification defines the implementation of crew joining functionality for the Journeyman Jobs application, enabling IBEW electrical workers to join crews through invite codes, browse public crews, and submit join requests.

### Critical Constraints (IMPLEMENTED ‚úÖ)

- **Maximum 10 members per crew** (reduced from 50)
- **Maximum 3 crew memberships per user** (newly implemented)
- **Two roles only:** Foreman (creator) and Member (everyone else)
- **MVP scope only** - Focus on core joining functionality

---

## üéØ Feature Requirements

### 1. Invite Code System

#### 1.1 Code Generation

**Format:** `CREWNAME-MM/YY-NNN`

**Example:** `SPARK-WIRE-10/25-001`

**Components:**

- `CREWNAME`: Sanitized crew name (uppercase, spaces replaced with hyphens, max 15 chars)
- `MM/YY`: Month and year of crew creation
- `NNN`: Incremental counter (001, 002, 003...)

**Generation Logic:**

```dart
// Pseudocode
String generateInviteCode(Crew crew, int counter) {
  final sanitized = crew.name
      .toUpperCase()
      .replaceAll(RegExp(r'\s+'), '-')
      .replaceAll(RegExp(r'[^A-Z0-9-]'), '')
      .substring(0, min(15, crew.name.length));

  final date = crew.createdAt;
  final monthYear = '${date.month.toString().padLeft(2, '0')}/${date.year.toString().substring(2)}';

  final counterStr = counter.toString().padLeft(3, '0');

  return '$sanitized-$monthYear-$counterStr';
}
```

**Storage:**

- Store in Firestore subcollection: `crews/{crewId}/inviteCodes/{codeId}`
- Document ID: Auto-generated by Firestore
- Document fields:

  ```typescript
  {
    code: string,              // The formatted invite code
    crewId: string,            // Reference to parent crew
    createdBy: string,         // User ID of code creator
    createdAt: Timestamp,      // When code was generated
    expiresAt: Timestamp,      // Expiration date (7 days default)
    isActive: boolean,         // Can be revoked
    usedBy: string | null,     // User ID who used this code (single-use)
    usedAt: Timestamp | null   // When code was used
  }
  ```

#### 1.2 Code Lifecycle

- **Type:** Single-use only
- **Expiration:** 7 days from creation
- **Permissions:** Any member can generate codes
- **Revocation:** Codes can be revoked by setting `isActive: false`
- **Regeneration:** New code with incremented counter

#### 1.3 Code Analytics

Track the following metrics:

- Total codes generated per crew
- Total successful joins via codes
- Which member generated which code
- Which user joined via which code
- Code usage rate (used vs expired)

**Storage:** Aggregate in `crews/{crewId}/stats` document

---

### 2. Crew Visibility & Privacy

#### 2.1 Visibility Settings

Add new field to `Crew` model:

```dart
enum CrewVisibility {
  public,      // Discoverable by anyone, listed in browse
  private      // Invite-only, not searchable or browsable
}
```

**Default:** `private` for new crews

#### 2.2 Public Crew Discovery

**Browse Features:**

- List all public crews
- Search by crew name
- Filter by:
  - Member count (e.g., "small crews" <5 members, "growing" 5-8, "full" 9-10)
  - Privacy setting (public only vs show all if admin)
  - Location (future enhancement, not MVP)

**Display Options (Test Multiple):**

1. **List View:** Scrollable list with crew cards
2. **Grid View:** 2-column grid of crew cards
3. **Pagination:** 20 crews per page with page navigation
4. **Infinite Scroll:** Load more as user scrolls

**UI Component:** `BrowseCrewsScreen`

---

### 3. Join Request Workflow

#### 3.1 Request Submission

When user clicks "Request to Join" on a public crew:

1. Validate user isn't already a member
2. Validate user hasn't reached 3-crew limit ‚úÖ
3. Validate crew hasn't reached 10-member limit ‚úÖ
4. Create join request document
5. Show success message: "Request sent to foreman"

#### 3.2 Request Approval/Rejection

**Foreman Actions:**

- View pending requests in Tailboard screen
- Approve: Add user to crew with `member` role
- Reject: Mark request as rejected, notify user

**Request Document Schema:**

```typescript
// Collection: crews/{crewId}/joinRequests/{requestId}
{
  id: string,
  crewId: string,
  userId: string,              // Requester
  requestedAt: Timestamp,
  status: 'pending' | 'approved' | 'rejected',
  reviewedBy: string | null,   // Foreman user ID
  reviewedAt: Timestamp | null,
  message: string | null       // Optional message from requester
}
```

#### 3.3 Notifications

**When to Notify:**

- Foreman receives notification when someone requests to join
- User receives notification when request is approved/rejected

**Implementation:** Use existing notification system or Cloud Functions

---

### 4. Data Model Changes

#### 4.1 Crew Model Updates

```dart
class Crew {
  // ... existing fields ...

  // NEW FIELDS:
  final CrewVisibility visibility;     // public or private
  final int maxMembers;                // Default: 10
  final String? activeInviteCode;      // Current active code (nullable)
  final int inviteCodeCounter;         // Incremental counter for code generation

  // REMOVE/SIMPLIFY:
  // - Remove MemberRole.lead (only foreman and member)
}
```

#### 4.2 User Model Updates (Future)

```dart
class UserModel {
  // ... existing fields ...

  // Track crew memberships for validation
  final List<String> crewIds;  // Max 3 crews
}
```

#### 4.3 New Collections

**Invite Codes:**

```
crews/{crewId}/inviteCodes/{codeId}
```

**Join Requests:**

```
crews/{crewId}/joinRequests/{requestId}
```

**User Join Requests (Mirror for notifications):**

```
users/{userId}/joinRequests/{requestId}
```

---

### 5. Service Layer Changes

#### 5.1 New Methods in `CrewService`

```dart
class CrewService {
  // Invite Code Management
  Future<String> generateInviteCode({
    required String crewId,
    required String generatedBy,
  });

  Future<void> revokeInviteCode({
    required String crewId,
    required String codeId,
  });

  Future<Crew?> validateAndGetCrewByCode(String code);

  Future<void> joinCrewWithCode({
    required String inviteCode,
    required String userId,
  });

  // Join Requests
  Future<String> submitJoinRequest({
    required String crewId,
    required String userId,
    String? message,
  });

  Future<void> approveJoinRequest({
    required String requestId,
    required String crewId,
    required String foremanId,
  });

  Future<void> rejectJoinRequest({
    required String requestId,
    required String crewId,
    required String foremanId,
    String? reason,
  });

  Future<List<JoinRequest>> getPendingJoinRequests(String crewId);

  // Crew Discovery
  Future<List<Crew>> searchPublicCrews({
    String? nameQuery,
    int? minMembers,
    int? maxMembers,
    int limit = 20,
    DocumentSnapshot? startAfter,
  });

  Stream<QuerySnapshot> getPublicCrewsStream({
    int limit = 20,
  });
}
```

#### 5.2 Updated Validation Methods

Already implemented in `lib/utils/validation.dart`:

- ‚úÖ `isUnderMemberLimit(int currentCount)` - Now checks < 10
- ‚úÖ `canJoinAnotherCrew(String userId, FirebaseFirestore firestore)` - Max 3 crews

**Add:**

```dart
class CrewValidation {
  /// Validate invite code format
  static String? validateInviteCode(String? code) {
    if (code == null || code.trim().isEmpty) {
      return 'Invite code is required';
    }
    // Format: CREWNAME-MM/YY-NNN
    final pattern = RegExp(r'^[A-Z0-9-]+-\d{2}/\d{2}-\d{3}$');
    if (!pattern.hasMatch(code.trim().toUpperCase())) {
      return 'Invalid invite code format';
    }
    return null;
  }
}
```

---

### 6. UI/UX Implementation

#### 6.1 Updated Screens

**1. `join_crew_screen.dart` (Current)**

- ‚úÖ Already has invite code input field
- **Add:** Actual joining logic (calls `joinCrewWithCode`)
- **Add:** Better error handling and loading states
- **Update:** "Browse Public Crews" button to navigate to new screen

**2. `browse_crews_screen.dart` (NEW)**

- Display public crews in list/grid view
- Search bar for crew name filtering
- Filter chips for member count ranges
- "Request to Join" button for each crew
- Show crew details: name, member count, foreman name, job preferences

**3. `crew_detail_screen.dart` (NEW)**

- Full crew information before joining
- Member list with avatars
- Job preferences summary
- "Request to Join" or "Join with Code" actions
- Statistics (optional for MVP)

**4. `tailboard_screen.dart` (Update)**

- **Add Tab:** "Join Requests" (foreman-only)
- Display pending requests with approve/reject buttons
- Show requester profile preview
- Notification badge on tab when pending requests exist

**5. `create_crew_screen.dart` (Update)**

- **Add:** Privacy setting selector (public/private)
- **Add:** Generate initial invite code button
- **Simplify:** Remove "Lead" role option (only Foreman/Member)

**6. `manage_invite_codes_screen.dart` (NEW)**

- List all generated codes with status (active/used/expired)
- "Generate New Code" button
- "Revoke Code" action
- Analytics: Who joined via which code
- Share code functionality (copy to clipboard, share via SMS/Email)

#### 6.2 New Widgets

```dart
// 1. Crew Card for Browse Screen
class CrewBrowseCard extends StatelessWidget {
  final Crew crew;
  final VoidCallback onTap;
  final VoidCallback onRequestJoin;
  // Display: name, member count, privacy badge, foreman name
}

// 2. Join Request Card
class JoinRequestCard extends StatelessWidget {
  final JoinRequest request;
  final Function(String requestId) onApprove;
  final Function(String requestId) onReject;
  // Display: requester info, request date, optional message
}

// 3. Invite Code Display
class InviteCodeCard extends StatelessWidget {
  final InviteCode code;
  final VoidCallback onRevoke;
  final VoidCallback onShare;
  // Display: code, status, created by, used by (if applicable)
}
```

---

### 7. Security & Firestore Rules

#### 7.1 Firestore Security Rules Updates

```javascript
// Invite Codes
match /crews/{crewId}/inviteCodes/{codeId} {
  // Any authenticated user can read active codes (to validate)
  allow read: if request.auth != null && resource.data.isActive == true;

  // Crew members can create codes
  allow create: if request.auth != null
    && isCrewMember(crewId, request.auth.uid);

  // Only code creator or foreman can revoke
  allow update: if request.auth != null
    && (resource.data.createdBy == request.auth.uid
        || isForeman(crewId, request.auth.uid));

  // No deletion
  allow delete: if false;
}

// Join Requests
match /crews/{crewId}/joinRequests/{requestId} {
  // Requester can read their own requests
  allow read: if request.auth != null
    && (resource.data.userId == request.auth.uid
        || isForeman(crewId, request.auth.uid));

  // Any authenticated user can create (with validation)
  allow create: if request.auth != null
    && request.resource.data.userId == request.auth.uid
    && !isCrewMember(crewId, request.auth.uid);

  // Only foreman can update (approve/reject)
  allow update: if request.auth != null
    && isForeman(crewId, request.auth.uid)
    && request.resource.data.status in ['approved', 'rejected'];
}

// Helper functions
function isCrewMember(crewId, userId) {
  return get(/databases/$(database)/documents/crews/$(crewId))
    .data.memberIds.hasAny([userId]);
}

function isForeman(crewId, userId) {
  return get(/databases/$(database)/documents/crews/$(crewId))
    .data.foremanId == userId;
}
```

#### 7.2 Rate Limiting

**Prevent Abuse:**

- Max 5 invite codes generated per user per day
- Max 10 join requests per user per day
- Max 3 pending join requests per user at any time

**Implementation:** Use existing counter system in `CrewService`

---

### 8. Testing Requirements

#### 8.1 Unit Tests

```dart
// test/features/crews/services/crew_service_test.dart

group('Invite Code Generation', () {
  test('generates code with correct format', () async {
    final code = await crewService.generateInviteCode(
      crewId: 'test-crew-id',
      generatedBy: 'user-123',
    );
    expect(code, matches(RegExp(r'^[A-Z0-9-]+-\d{2}/\d{2}-\d{3}$')));
  });

  test('increments counter correctly', () async {
    final code1 = await crewService.generateInviteCode(...);
    final code2 = await crewService.generateInviteCode(...);
    expect(code2, endsWith('-002'));
  });
});

group('Crew Membership Limits', () {
  test('rejects join when user has 3 crews', () async {
    // User already in 3 crews
    expect(
      () => crewService.acceptInvitation(...),
      throwsA(isA<MemberException>().having(
        (e) => e.code,
        'code',
        'user-crew-limit-reached',
      )),
    );
  });

  test('rejects member when crew has 10 members', () async {
    // Crew already has 10 members
    expect(
      () => crewService.inviteMember(...),
      throwsA(isA<CrewException>().having(
        (e) => e.code,
        'code',
        'member-limit-reached',
      )),
    );
  });
});
```

#### 8.2 Integration Tests

```dart
// test/integration/crew_joining_flow_test.dart

testWidgets('complete invite code joining flow', (tester) async {
  // 1. Foreman generates invite code
  // 2. Code is displayed with share options
  // 3. New user enters code in JoinCrewScreen
  // 4. User successfully joins crew
  // 5. Code is marked as used
});

testWidgets('join request approval workflow', (tester) async {
  // 1. User browses public crews
  // 2. User submits join request
  // 3. Foreman sees request in Tailboard
  // 4. Foreman approves request
  // 5. User is added to crew
  // 6. Both receive notifications
});
```

#### 8.3 Widget Tests

```dart
// test/features/crews/screens/browse_crews_screen_test.dart

testWidgets('displays public crews correctly', (tester) async {
  await tester.pumpWidget(MaterialApp(home: BrowseCrewsScreen()));
  expect(find.byType(CrewBrowseCard), findsWidgets);
});

testWidgets('search filters crews by name', (tester) async {
  await tester.enterText(find.byType(TextField), 'Spark');
  await tester.pump();
  expect(find.text('Spark Wire Crew'), findsOneWidget);
});
```

---

### 9. Implementation Phases

#### Phase 1: Critical Fixes & Core Infrastructure (COMPLETED ‚úÖ)

- ‚úÖ Fix member limit to 10
- ‚úÖ Implement 3-crew-per-user validation
- ‚úÖ Add `canJoinAnotherCrew` validation method

#### Phase 2: Invite Code System (Week 1)

**Priority: HIGH**

**Tasks:**

1. Update `Crew` model with new fields
   - `visibility: CrewVisibility`
   - `maxMembers: int`
   - `activeInviteCode: String?`
   - `inviteCodeCounter: int`

2. Create `InviteCode` model

   ```dart
   class InviteCode {
     final String id;
     final String code;
     final String crewId;
     final String createdBy;
     final DateTime createdAt;
     final DateTime expiresAt;
     final bool isActive;
     final String? usedBy;
     final DateTime? usedAt;
   }
   ```

3. Implement invite code generation in `CrewService`
   - `generateInviteCode()`
   - `revokeInviteCode()`
   - `validateAndGetCrewByCode()`
   - `joinCrewWithCode()`

4. Update `join_crew_screen.dart` with actual joining logic
   - Connect form to `joinCrewWithCode`
   - Add proper error handling
   - Add success navigation to Tailboard

5. Create `manage_invite_codes_screen.dart`
   - List generated codes
   - Generate/revoke functionality
   - Share code functionality

**Deliverables:**

- ‚úÖ Working invite code generation
- ‚úÖ Users can join crews with codes
- ‚úÖ Codes properly validated and marked as used

#### Phase 3: Crew Discovery & Search (Week 2)

**Priority: HIGH**

**Tasks:**

1. Add visibility field to crew creation
   - Update `create_crew_screen.dart`
   - Add public/private selector

2. Create `browse_crews_screen.dart`
   - Implement list view
   - Add search by name
   - Add member count filter
   - Test pagination vs infinite scroll

3. Implement `CrewBrowseCard` widget
   - Display crew info
   - "Request to Join" button
   - Privacy badge

4. Create `crew_detail_screen.dart`
   - Show full crew details
   - Member list
   - Job preferences
   - Join actions

5. Implement search methods in `CrewService`
   - `searchPublicCrews()`
   - `getPublicCrewsStream()`

**Deliverables:**

- ‚úÖ Users can browse public crews
- ‚úÖ Search and filter functionality working
- ‚úÖ Multiple display modes tested

#### Phase 4: Join Request Workflow (Week 3)

**Priority: MEDIUM**

**Tasks:**

1. Create `JoinRequest` model

2. Implement join request methods in `CrewService`
   - `submitJoinRequest()`
   - `approveJoinRequest()`
   - `rejectJoinRequest()`
   - `getPendingJoinRequests()`

3. Add "Join Requests" tab to `tailboard_screen.dart`
   - Show only to foreman
   - Display pending requests
   - Approve/reject buttons

4. Create `JoinRequestCard` widget

5. Implement notifications
   - On new join request (to foreman)
   - On approval/rejection (to requester)

**Deliverables:**

- ‚úÖ Join request submission working
- ‚úÖ Foreman can approve/reject
- ‚úÖ Notifications sent

#### Phase 5: Role Simplification (Week 4)

**Priority: LOW (Can be done anytime)

**Tasks:**

1. Remove `MemberRole.lead` enum value

2. Update all references to only use:
   - `MemberRole.foreman`
   - `MemberRole.member`

3. Update UI to reflect two-role system
   - Remove "Lead" option from role selectors
   - Update role display in member lists

4. Migrate existing "Lead" members to "Member" role
   - Create migration script
   - Update Firestore documents

**Deliverables:**

- ‚úÖ Only two roles exist: Foreman and Member
- ‚úÖ All existing data migrated

#### Phase 6: Testing & Polish (Week 5)

**Priority: MEDIUM**

**Tasks:**

1. Write unit tests for all new methods

2. Create integration tests for:
   - Invite code flow
   - Join request flow
   - Crew discovery flow

3. Widget tests for new screens

4. Manual QA testing
   - Test all edge cases
   - Verify rate limiting
   - Test notifications

5. Performance optimization
   - Ensure search is fast (<500ms)
   - Optimize crew list rendering

**Deliverables:**

- ‚úÖ 80%+ test coverage for new code
- ‚úÖ All flows tested end-to-end
- ‚úÖ No critical bugs

---

### 10. Migration Plan

#### 10.1 Existing Crews

**Update all existing crew documents:**

```dart
// Migration script
Future<void> migrateExistingCrews() async {
  final crews = await FirebaseFirestore.instance
      .collection('crews')
      .get();

  final batch = FirebaseFirestore.instance.batch();

  for (final doc in crews.docs) {
    batch.update(doc.reference, {
      'visibility': 'private',      // Default to private
      'maxMembers': 10,              // Update from 50
      'inviteCodeCounter': 0,        // Initialize counter
      'activeInviteCode': null,      // No code yet
    });
  }

  await batch.commit();
}
```

#### 10.2 Existing Members with "Lead" Role

```dart
// Migration script
Future<void> migrateLead ToMember() async {
  final crews = await FirebaseFirestore.instance
      .collection('crews')
      .get();

  for (final crewDoc in crews.docs) {
    final members = await crewDoc.reference
        .collection('members')
        .where('role', isEqualTo: 'lead')
        .get();

    final batch = FirebaseFirestore.instance.batch();

    for (final memberDoc in members.docs) {
      batch.update(memberDoc.reference, {
        'role': 'member',
        'permissions': MemberPermissions.fromRole(MemberRole.member).toMap(),
      });
    }

    await batch.commit();
  }
}
```

---

### 11. Analytics & Monitoring

#### 11.1 Key Metrics to Track

- Total invite codes generated
- Invite code usage rate (used / total generated)
- Average time from code generation to usage
- Join request approval rate
- Average time from request to approval
- Most popular crew search terms
- Public crew discovery vs invite code joins

#### 11.2 Implementation

Use existing `AnalyticsService` and add events:

```dart
analytics.logEvent(
  name: 'invite_code_generated',
  parameters: {'crewId': crewId, 'generatedBy': userId},
);

analytics.logEvent(
  name: 'crew_joined_via_code',
  parameters: {'crewId': crewId, 'code': inviteCode},
);

analytics.logEvent(
  name: 'join_request_submitted',
  parameters: {'crewId': crewId, 'userId': userId},
);
```

---

### 12. Future Enhancements (Post-MVP)

**Not included in MVP but recommended for future:**

1. **Multi-use invite codes** with max usage limits
2. **Location-based crew discovery** using GeoFirestore
3. **Crew ratings and reviews** from members
4. **Crew tags/specializations** for better search
5. **QR code generation** for invite codes
6. **Crew join history** tracking
7. **Automated crew recommendations** based on user profile
8. **Crew capacity warnings** when approaching 10-member limit
9. **Waitlist functionality** for full crews
10. **Direct messaging** before joining

---

### 13. Success Criteria

The MVP is considered successful when:

- ‚úÖ Users can generate and share invite codes in correct format
- ‚úÖ Users can join crews using valid invite codes
- ‚úÖ Invite codes expire after 7 days
- ‚úÖ Single-use codes are properly enforced
- ‚úÖ Users can browse public crews and filter by name/member count
- ‚úÖ Users can submit join requests to public crews
- ‚úÖ Foremen can approve/reject join requests
- ‚úÖ Notifications are sent for joins and approvals
- ‚úÖ Max 10 members per crew is enforced
- ‚úÖ Max 3 crews per user is enforced
- ‚úÖ Only Foreman and Member roles exist
- ‚úÖ 80%+ test coverage for new code
- ‚úÖ No critical bugs in production

---

## üìé Appendix

### A. Related Files

**Models:**

- `lib/features/crews/models/crew.dart` ‚úèÔ∏è Update
- `lib/features/crews/models/invite_code.dart` üÜï Create
- `lib/features/crews/models/join_request.dart` üÜï Create

**Services:**

- `lib/features/crews/services/crew_service.dart` ‚úèÔ∏è Update
- `lib/utils/validation.dart` ‚úÖ Updated

**Screens:**

- `lib/features/crews/screens/join_crew_screen.dart` ‚úèÔ∏è Update
- `lib/features/crews/screens/browse_crews_screen.dart` üÜï Create
- `lib/features/crews/screens/crew_detail_screen.dart` üÜï Create
- `lib/features/crews/screens/manage_invite_codes_screen.dart` üÜï Create
- `lib/features/crews/screens/create_crew_screen.dart` ‚úèÔ∏è Update
- `lib/features/crews/screens/tailboard_screen.dart` ‚úèÔ∏è Update

**Widgets:**

- `lib/features/crews/widgets/crew_browse_card.dart` üÜï Create
- `lib/features/crews/widgets/join_request_card.dart` üÜï Create
- `lib/features/crews/widgets/invite_code_card.dart` üÜï Create

### B. Database Indexes Required

```json
// Firestore Composite Indexes

// 1. Search public crews by name
{
  "collectionGroup": "crews",
  "fields": [
    {"fieldPath": "visibility", "order": "ASCENDING"},
    {"fieldPath": "isActive", "order": "ASCENDING"},
    {"fieldPath": "name", "order": "ASCENDING"}
  ]
}

// 2. Filter crews by member count
{
  "collectionGroup": "crews",
  "fields": [
    {"fieldPath": "visibility", "order": "ASCENDING"},
    {"fieldPath": "memberCount", "order": "ASCENDING"},
    {"fieldPath": "lastActivityAt", "order": "DESCENDING"}
  ]
}

// 3. Get pending join requests
{
  "collectionGroup": "joinRequests",
  "fields": [
    {"fieldPath": "crewId", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "requestedAt", "order": "DESCENDING"}
  ]
}
```

### C. Error Codes

| Code | Message | Action |
|------|---------|--------|
| `invalid-invite-code` | Invalid invite code format | Check code format |
| `invite-code-expired` | This invite code has expired | Request new code |
| `invite-code-used` | This invite code has already been used | Request new code |
| `crew-not-found` | Crew not found for this invite code | Verify code |
| `member-limit-reached` | Crew has reached maximum member limit (10) | Cannot join |
| `user-crew-limit-reached` | You have reached the maximum crew membership limit (3 crews) | Leave a crew first |
| `already-member` | You are already a member of this crew | Navigate to crew |
| `join-request-pending` | You already have a pending join request for this crew | Wait for approval |

---

**Document End**

*For questions or clarifications, contact the development team.*
